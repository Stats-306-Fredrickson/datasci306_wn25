---
title: "Stats 306: Lecture 3"
subtitle: "More data exploration with ggplot"
author: "Mark Fredrickson"
output: 
  learnr::tutorial:
    progressive: true
    css: css/lecture.css
runtime: shiny_prerendered
---


```{r setup, include=FALSE}
library(learnr)
library(tidyverse)
```

## Review: More on R

* Learned more about R's functions (required and optional arguments)
* Piping and assignment
* Special values: `NA`, `NULL`, and `NaN`
* Vectors: ordered collections of same type, many computations are *vectorized*
* Lists: ordered collections of mixed types
* Tables: lists of vectors of the same length (column oriented)
* Other items: indexing with `[]` and `$`, `dim` and `colnames` for tables

## Vectorized computations in R

In R, since (almost) *everything* is a vector (of length 1 if need be), most computations in R allow the use of **vectorized** computations: computations that apply to **each item in a vector** or **use the entire vector**.

```{r}
miles_per_gallon_city <- mpg$cty
sum(miles_per_gallon_city)
gallons_per_mile_city <- 1 / miles_per_gallon_city
miles_per_gallon_city[1:3]
gallons_per_mile_city[1:3]
total_mpg <- miles_per_gallon_city + mpg$hwy
mpg$hwy[1:3]
total_mpg[1:3]
```

## Vectorized Computations with Logical Values

We saw relational operators in the last lecture (`<`, `>`, `==`, etc.) and that they can apply in a vectorized way.

```{r}
top_half <- mpg$cty > median(mpg$cty)
top_half[1:5]

## average highway efficiency of cars in top 50% of city efficiency:
mpg$hwy[top_half] |> mean()
```

## Other uses for logicals

R has a convenient convention that `TRUE == 1` and `FALSE == 0`. Notice that if we want to **count** this is equivalent to **summing** a logical vector.

```{r}
# How many cars get more than 30 miles per gallon in the city?
sum(mpg$cty > 30)
```

## Exercise

How many diamonds in the `diamonds` table cost more than $5000? What was the mean carat rating of these diamonds? (Bonus: what *proportion* of diamonds cost more than $5000 -- can you figure it out with one function call?)

```{r expensive-diamonds, exercise = TRUE}

```


```{r expensive-diamonds-solution}
expensive <- diamonds$price > 5000
sum(expensive) ## how many
mean(keep(diamonds$price, expensive)) ## could also use [] indexing
mean(expensive) ## bonus
```



## Review: Graphing and Plotting

**Graphing** or **plotting** is the representation of data in a visual form, typically on a 2D plane.

Humans have a wonderful ability to process visual stimuli quickly.

Great for displaying large data sets that might be difficult to describe.

## Plotting ain't easy

* What exactly can we put in a plot?
* How to connect the plot to data?
* What are our goals for the plot?
* What additional information is necessary to understand the plot?

## The Semiology of Graphics

In 1967, **Jacques Bertin** published the *Semiology of Graphics* to describe common elements of plots and what they could achieve.

Bertin described two ways of thinking about plots:

1. Visual ("retinal") variables: connections between objects in the plot and underlying data
2. Relationship what types of relationships can the visual variables express

## Visual variables/retinal variables:

* Position/planar dimensions
* Size (small to large)
* Value (light to dark)
* Texture (pattern)
* Color (discrete or continuously varying)
* Orientation (angle/rotation)
* Shape (usually distinct shapes)

## Relationships

* Selection: find groups that are the same
* Association: find units in different groups that share qualities
* Order: natural sequence in the variable
* Quantitative: read relative differences as actual changes in data

---

![Visual Variables](./images/bertin_visual_variables.png)

## The Grammar of Graphics and `ggplot`

A follow up to Bertin's work was *The Grammar of Graphics* by Leland Wilkinson.
This book described a programming language for graphics based on ideas in
Bertin's system.

The GoG was implemented for R in `ggplot` (and later replaced by `ggplot2`). (See
the GGPlot Book on Canvas for more details.)

## The components of a ggplot graph

* The graph object itself (creating using `ggplot(data)`)
* A set of *aesthetic* mappings (connecting data to visual variables)
* Layers: collections of geometric elements (`geom_*()`) and statistical transformations (`stat_*()`)
* Scales: information on the range or composition of variables
* Coordinate systems: how the data are arranged spatially
* Facet: breaking a single plot into many, similar plots
* Theme: all the other color and printing aspects of the plot

## Creating a ggplot

Start use the `ggplot` function to start our plot
```{r}
efficiency <- ggplot(data = mpg)
class(efficiency)
efficiency # for now, blank
```

## Connecting columns to visual variables

What can we plot?
```{r}
colnames(mpg)
```

"Aesthetic" mappings connect columns to visual variables
```{r}
efficiency <- ggplot(data = mpg,
                     aes(x = displ, y = hwy, color = cyl))
```

## Geometries: objects on the plot

In the previous we connected visual variables to columns, now we need to explain how to display them.

We will use a **geometry function** (have the form `geom_TYPE()`).

```{r}
efficiency + geom_point()
```

## Alternative form

```{r}
ggplot(data = mpg) + geom_point(aes(x = displ, y = hwy, color = cyl))
```

## Exercise: Great Lakes water levels

Here's a data set from the US Army Corps of Engineers showing the height of the Great Lakes (with Michigan and Huron being one body) above sea level, aggregate by year.

```{r}
glwl <- read_csv("data/GLHYD_data_english_cleaned.csv.gz") |>
  group_by(body, year) |> summarize(ht = median(height_ft)) |> ungroup()
glwl
```

Use this data set to make a scatter plot of the height of each lake in each year, colored by which `body` the reading is from.

```{r glwl-plot-setup}

glwl <- read_csv("data/GLHYD_data_english_cleaned.csv.gz") |>
  group_by(body, year) |> summarize(ht = median(height_ft)) |> ungroup()
```

```{r glwl-plot, exercise = TRUE}
```

```{r glwl-solution}
ggplot(glwl, aes(x = year, y = ht, color = body)) + geom_point()
ggplot(glwl, aes(x = year, y = ht, color = body)) + geom_line()
```


Improve your plot by changing it to a `geom_line()`

## What aesthetic mappings can I use?

Let's visit the docs: [`geom_point`](https://ggplot2.tidyverse.org/reference/geom_point.html)

## Trying out some other mappings

```{r}
ggplot(data = mpg,
       aes(x = displ, y = hwy,
           size = cyl,
           color = class)) + 
  geom_point()
```

## Using expressions

We can also use expressions involving columns.

```{r}
ggplot(data = mpg,
       aes(x = displ, y = hwy,
           shape = year > 2000)) + 
  geom_point()
```

## Overriding parameters for all points

We can pass in constants that apply to all points (size and transparency):

```{r}
ggplot(data = mpg,
       aes(x = displ, y = hwy,
           shape = year > 2000)) + 
  geom_point(size = 5, alpha = 0.5)
```

## Jitter: useful noise

```{r}
ggplot(data = mpg,
       aes(x = displ, y = hwy)) + 
  geom_point(position = "jitter")
```

## Other geometries

Points are great for graphing two **quantitative** or **continuous** variables.
For **discrete** or **qualitative** we need other tools.

```{r}
ggplot(data = mpg,
       aes(x = displ, y = class)) + 
  geom_boxplot() 
```

## List of geometries

[More ggplot documentation](https://ggplot2.tidyverse.org/reference/index.html#geoms).


## Statistical Summaries

* In addition to the raw data (or our calculations), many plots use **data summaries** 
* `ggplot2` calls these **summary statistics** or `stat_*` functions
* We already saw a summaries in the boxplot: quantiles, twice IQR bars
* We can access summaries that geometries compute and add additional summaries.

## Boxplot as statistic

```{r}
median(mpg$displ)
quantile(mpg$displ, c(0.25, 0.75))
```

```{r}
ggplot(data = mpg,
       aes(x = displ)) + 
  geom_boxplot() 
```


## Adding computed summaries

The `stat_summary` function allows you to use any function to summarize 

```{r}
ggplot(data = mpg,
       aes(x = displ, y = class)) + 
  geom_boxplot() +
  stat_summary(fun = mean, size = 3, color = "red", geom = "point") 
```

## Trend lines

When using scatter plots, one of the most common summaries is a **trend line**.
```{r}
ggplot(data = mpg,
       aes(x = displ, y = hwy)) + 
  geom_point(position = "jitter", alpha = 0.25) +
  stat_smooth() # geom_smooth also works
```

## More layering

```{r}
ggplot(data = mpg, aes(x = displ)) +
  geom_point(aes(y = hwy), color = "orange") +
  geom_point(aes(y = cty), color = "blue") +
  stat_smooth(aes(y = hwy), lty = 1, color = "black") +
  stat_smooth(aes(y = cty), lty = 2, color = "black")
```

We'll see a better way to make this table when we talk about tall vs. wide format data.

## Overriding defaults of `stat` functions

Each `geom_*` has a default statistic function. We can override this.

```{r}
ggplot(data = mpg, aes(x = class)) +
  geom_bar() # default stat is count
```

## Average highway efficiency by class

```{r}
ggplot(data = mpg, aes(x = class, y = hwy)) +
  geom_bar(stat = "summary", fun = "mean") 
```

## Replacing tables

We often use **tables** in documents to give numerical summaries. But why not
replace those with a nice graphic?
```{r}
ggplot(data = mpg, aes(x = class, y = hwy)) +
  stat_summary(
    fun.min = min,
    fun.max = max,
    fun = median
  )
```

## Exporting Plots

* Automatically included in knitted RMarkdown documents
* Export from the Plots panel in RStudio/Posit Cloud
* `ggsave` function to save to file (variety of formats)

